<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screens Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --color-primary: #cf6716;
            --color-primary-hover: #b85a13;
            --color-bg: #0a0a0a;
            --color-surface: #1a1a1a;
            --color-surface-alt: #1e1e1e;
            --color-surface-brighter: #2c2c2c;
            --color-border: #2c2c2c;
            --color-border-hover: #3d3d3d;
            --color-text: #ffffff;
            --color-text-half: #aaaaaa;
            --color-text-muted: #888888;
            --color-text-dim: #666666;
            --color-danger: #ef4444;
            --color-danger-bg: rgba(239, 68, 68, 0.1);
            --color-success: #22c55e;
            --color-success-bg: rgba(34, 197, 94, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .title-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 36px;
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            -webkit-app-region: drag;
            user-select: none;
            padding: 0 12px;
            flex-shrink: 0;
        }

        .title-bar-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .title-bar-logo {
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover));
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .title-bar-logo .material-icons {
            font-size: 14px;
            color: white;
        }

        .title-bar-text {
            font-size: 13px;
            color: var(--color-text);
            font-weight: 600;
        }

        .title-bar-version {
            font-size: 11px;
            color: var(--color-text-dim);
            font-weight: 500;
        }

        .station-tag {
            font-size: 11px;
            background: rgba(207, 103, 22, 0.15);
            color: var(--color-primary);
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            border: 1px solid rgba(207, 103, 22, 0.3);
            cursor: pointer;
            transition: all 0.2s;
            -webkit-app-region: no-drag;
            position: relative;
            z-index: 10;
        }

        .station-tag:hover {
            background: rgba(207, 103, 22, 0.25);
            border-color: var(--color-primary);
        }

        .title-bar-controls {
            display: flex;
            gap: 4px;
            -webkit-app-region: no-drag;
        }

        .title-bar-button {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .title-bar-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .title-bar-button.close:hover {
            background: #ef4444;
        }

        .main-container {
            flex: 1;
            display: flex;
            gap: 16px;
            padding: 16px;
            overflow: hidden;
        }

        .screens-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 320px;
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
        }

        .panel-title .material-icons {
            font-size: 18px;
            color: var(--color-primary);
        }

        .screens-count {
            font-size: 11px;
            color: var(--color-text-muted);
            background: var(--color-surface-brighter);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .screens-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .screen-card {
            background: var(--color-surface);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid var(--color-border);
            transition: border 0.2s;
        }

        .screen-card:hover {
            border-color: var(--color-border-hover);
        }

        .screen-card.active {
            border-left: 3px solid var(--color-success);
        }

        .screen-card.empty {
            border-left: 3px solid #444444;
        }

        .screen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .screen-badge {
            background: var(--color-primary);
            color: var(--color-text);
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 700;
        }

        .form-control {
            width: 100%;
            height: 36px;
            padding: 0 10px;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            color: var(--color-text);
            font-size: 13px;
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .small-input {
            font-size: 12px;
            padding: 4px 8px;
            height: 28px;
        }

        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 0 45px;
            height: 40px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--color-primary);
            color: var(--color-text);
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-secondary {
            background: #2c2c2c;
            color: #aaaaaa;
        }

        .btn-secondary:hover {
            background: #3d3d3d;
            color: #ffffff;
        }

        .btn-mini {
            padding: 2px 8px;
            height: 28px;
            font-size: 11px;
            border-radius: 3px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
        }

        .btn-mini.primary {
            background: var(--color-primary);
        }

        .btn-mini.danger {
            background: #ef4444;
        }

        .btn-mini.secondary {
            background: #4b5563;
        }

        .gpu-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #1e1e1e;
            border: 1px solid var(--color-border-hover);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .gpu-badge.optimal {
            border-color: #22c55e66;
            background: rgba(34, 197, 94, 0.05);
        }

        .gpu-badge.warning {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #1a1a1a;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 12px;
            transition: all 0.3s;
            z-index: 1000;
            border: 1px solid #2c2c2c;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .credentials-inline {
            background: #2a2a2a;
            padding: 8px;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 8px;
        }

        .hidden {
            display: none !important;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            max-width: 320px;
            width: 90%;
            border: 1px solid #2c2c2c;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .modal-message {
            font-size: 13px;
            color: #888888;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            border: none;
        }

        .btn-danger {
            background: rgba(220, 38, 38, 0.1);
            color: #ef4444;
            border: 1px solid rgba(220, 38, 38, 0.3);
            box-shadow: none;
            width: 100%;
            height: 48px;
            justify-content: center;
            padding: 0 16px;
            gap: 12px;
            text-transform: none;
            font-size: 13px;
            font-weight: 600;
        }

        .btn-danger:hover {
            background: rgba(220, 38, 38, 0.2);
            border-color: #ef4444;
        }

        /* Setup/Config Modal Specifics */
        .setup-input {
            width: 100%;
            background: #000;
            border: 1px solid var(--color-border);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            margin: 20px 0;
            text-align: center;
            outline: none;
        }

        .setup-input:focus {
            border-color: var(--color-primary);
        }

        .modal-btn-cancel {
            background: transparent;
            color: #888888;
            border: 1px solid #2c2c2c;
        }

        .modal-btn-confirm {
            background: var(--color-primary);
            color: var(--color-text);
        }

        .modal-btn-confirm.danger {
            background: var(--color-danger);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #3d3d3d;
            border-radius: 3px;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            appearance: none;
            margin: 0;
        }

        input[type=number] {
            appearance: textfield;
        }
    </style>
</head>

<body>
    <div class="title-bar">
        <div class="title-bar-left">
            <div class="title-bar-logo">
                <span class="material-icons">monitor</span>
            </div>
            <span class="title-bar-text">Screens</span>
            <span class="title-bar-version" id="agent-version"></span>
            <span id="station-name-display" class="station-tag" title="Click para cambiar nombre">Local</span>
        </div>
        <div class="title-bar-controls">
            <div class="title-bar-button" id="btn-minimize">
                <span class="material-icons">minimize</span>
            </div>
            <div class="title-bar-button close" id="btn-window-close">
                <span class="material-icons">close</span>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="screens-panel">
            <div class="panel-header">
                <div class="panel-title">
                    <span class="material-icons">desktop_windows</span>
                    Pantallas Conectadas
                </div>
                <span class="screens-count" id="screens-count">0</span>
            </div>
            <div class="screens-list" id="screens-list"></div>
        </div>

        <div class="controls-panel">
            <div class="card">
                <div id="gpu-diagnostic-container">
                    <div class="gpu-badge" id="gpu-badge">
                        <span class="material-icons gpu-icon" id="gpu-icon">memory</span>
                        <div class="gpu-info-text">
                            <span class="gpu-label"
                                style="font-weight:700; font-size:10px; color:#888; display:block;">GPU</span>
                            <span class="gpu-name" id="gpu-name"
                                style="color:#fff; font-weight:600; display:block; font-size:11px;">Cargando...</span>
                        </div>
                    </div>
                </div>

                <div class="agent-actions" style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn btn-secondary" id="btn-restart">
                        <span class="material-icons">restart_alt</span>
                        Reiniciar App
                    </button>
                    <button class="btn btn-secondary" id="btn-update">
                        <span class="material-icons">system_update</span>
                        Buscar Actualización
                    </button>
                    <button class="btn btn-secondary" id="btn-logs">
                        <span class="material-icons">description</span>
                        Logs del Sistema
                    </button>
                    <hr style="border:0; border-top:1px solid #444;">
                    <button class="btn btn-danger" id="btn-quit">
                        <span class="material-icons">power_settings_new</span>
                        Cerrar Aplicación
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal">
            <div class="modal-title" id="modal-title"></div>
            <div class="modal-message" id="modal-message"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" id="modal-cancel">Cancelar</button>
                <button class="modal-btn modal-btn-confirm" id="modal-confirm">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- Setup Modal -->
    <div id="setup-modal" class="modal-overlay" style="z-index: 2000;">
        <div class="modal" style="max-width: 400px; text-align: center;">
            <div class="modal-header"
                style="margin-bottom:15px; border-bottom:1px solid var(--color-border); padding-bottom:10px;">
                <h3 id="setup-modal-title" style="color:var(--color-primary);">Configuración Inicial</h3>
            </div>
            <div class="modal-body">
                <input type="text" id="setup-station-name" class="setup-input" placeholder="Nombre del Local"
                    maxlength="30">
            </div>
            <div class="modal-footer" style="margin-top:20px; display: flex; gap: 10px;">
                <button id="btn-cancel-setup" class="modal-btn-cancel hidden"
                    style="flex: 1; height:44px; border-radius:8px; cursor:pointer;">Cancelar</button>
                <button id="btn-save-setup" class="modal-btn-confirm"
                    style="flex: 2; height:44px; border-radius:8px; border:none; cursor:pointer; font-weight:600;">Completar
                    Instalación</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * GLOBAL STATE & REFS
         */
        let screens = [];
        let presetsHtml = '';
        const screensList = document.getElementById('screens-list');
        const screensCount = document.getElementById('screens-count');
        const modalOverlay = document.getElementById('modal-overlay');
        let modalCallback = null;

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => notification.classList.remove('show'), 4000);
        }

        function showModal(title, message, confirmText = 'Aceptar', isDanger = false) {
            return new Promise((resolve) => {
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-message').textContent = message;
                const confirmBtn = document.getElementById('modal-confirm');
                confirmBtn.textContent = confirmText;
                confirmBtn.classList.toggle('danger', isDanger);
                modalOverlay.classList.add('show');
                modalCallback = resolve;
            });
        }

        function hideModal() { modalOverlay.classList.remove('show'); }

        document.getElementById('modal-confirm').addEventListener('click', () => { hideModal(); if (modalCallback) modalCallback(true); });
        document.getElementById('modal-cancel').addEventListener('click', () => { hideModal(); if (modalCallback) modalCallback(false); });

        /**
         * RENDER LOGIC
         */
        async function loadScreens() {
            try {
                screens = await window.electron.getScreens();
                renderScreensList();
            } catch (error) { console.error('Error loading screens:', error); }
        }

        function renderScreensList() {
            const isEditing = document.activeElement &&
                (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'SELECT') &&
                screensList.contains(document.activeElement);

            if (isEditing) {
                // Background update of status only
                screens.forEach(screen => {
                    const card = document.querySelector(`.screen-card[data-id="${screen.id}"]`);
                    if (card) {
                        const statusDiv = card.querySelector('.screen-current-status');
                        const statusHtml = screen.hasContent ?
                            `<div style="color:var(--color-success); display:flex; align-items:center; gap:5px; font-weight:600;">
                                <span class="material-icons" style="font-size:16px;">play_circle</span>
                                ${screen.contentName || 'Contenido Activo'}
                            </div>` :
                            '<div style="color:#666; font-style:italic; display:flex; align-items:center; gap:6px;">' +
                            '<span class="material-icons" style="font-size:16px; opacity:0.5;">pause_circle</span>' +
                            'Sin contenido</div>';
                        if (statusDiv && statusDiv.innerHTML !== statusHtml) statusDiv.innerHTML = statusHtml;
                    }
                });
                return;
            }

            screensCount.textContent = screens.length;

            screensList.innerHTML = screens.map(screen => `
                <div class="screen-card ${screen.hasContent ? 'active' : 'empty'}" data-id="${screen.id}">
                    <div class="screen-header">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="screen-badge">Pantalla ${screen.id}</span>
                            <!-- Timer/Refresh Display -->
                            <div title="Intervalo de recarga" style="display: flex; align-items: center; gap: 6px; background: rgba(255,102,0,0.1); padding: 4px 10px; border-radius: 4px; border: 1px solid rgba(255,102,0,0.3);">
                                <span class="material-icons" style="font-size: 14px; color: #ff6600;">schedule</span>
                                <input type="number" class="refresh-input" value="${screen.refreshInterval || 0}" min="0" max="1440" 
                                    style="width: 35px; background: transparent; border: none; color: #fff; font-size: 12px; font-weight: 700; outline: none; text-align: center;">
                                <span style="font-size: 10px; color: #888; font-weight: 700;">MIN</span>
                            </div>
                        </div>
                        <span style="font-size:11px; color:#666;">${screen.width}×${screen.height}</span>
                    </div>

                    <div class="screen-current-status" style="margin:10px 0; font-size:13px;">
                        ${screen.hasContent ?
                    `<div style="color:var(--color-success); display:flex; align-items:center; gap:6px; font-weight:600;">
                                <span class="material-icons" style="font-size:18px;">play_circle</span>
                                ${screen.contentName || 'Contenido Activo'}
                             </div>` :
                    `<div style="color:#666; font-style:italic; display:flex; align-items:center; gap:6px;">
                                <span class="material-icons" style="font-size:18px; opacity:0.5;">pause_circle</span>
                                Sin contenido
                             </div>`
                }
                    </div>

                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <select class="form-control preset-select" data-screen-id="${screen.id}">
                            ${presetsHtml || '<option value="">Cargando...</option>'}
                        </select>



                        <!-- Credentials block (Luckia-specific or general) -->
                        <div class="credentials-inline hidden" id="creds-${screen.id}">
                            <input type="text" class="form-control small-input user-input" placeholder="Usuario" id="user-${screen.id}">
                            <input type="password" class="form-control small-input pass-input" placeholder="Contraseña" id="pass-${screen.id}">
                        </div>

                        <div style="display:flex; justify-content:flex-end; gap:5px;">
                            <button class="btn-mini primary" onclick="sendUrl('${screen.id}')">
                                <span class="material-icons" style="font-size:14px;">send</span> Enviar
                            </button>
                            ${screen.hasContent ? `
                                <button class="btn-mini secondary" onclick="refreshScreen('${screen.id}')" title="Recargar">
                                    <span class="material-icons" style="font-size:14px;">refresh</span>
                                </button>
                                <button class="btn-mini danger" onclick="closeScreen('${screen.id}')" title="Cerrar">
                                    <span class="material-icons" style="font-size:14px;">close</span>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        /**
         * ACTIONS
         */
        async function sendUrl(screenId) {
            const card = document.querySelector(`.screen-card[data-id="${screenId}"]`);
            const select = card.querySelector('.preset-select');
            const refreshInput = card.querySelector('.refresh-input');
            const url = select.value;
            const interval = parseInt(refreshInput.value) || 0;

            if (!url) return showNotification('Selecciona contenido', 'warning');

            let credentials = null;
            const contentName = select.options[select.selectedIndex].text;

            // Luckia-specific credentials handling
            if (contentName.toLowerCase().includes('luckia')) {
                const user = document.getElementById(`user-${screenId}`).value.trim();
                const pass = document.getElementById(`pass-${screenId}`).value.trim();
                if (user && pass) {
                    credentials = { username: user, password: pass };
                    await window.electron.saveCredential('luckia_user', user);
                    await window.electron.saveCredential('luckia_pass', pass);
                } else {
                    return showNotification('Luckia requiere credenciales', 'warning');
                }
            }

            window.electron.sendUrlToScreen(screenId, url, {
                contentName,
                refreshInterval: interval,
                credentials
            });
            showNotification(`Enviando a Pantalla ${screenId}...`, 'success');
            setTimeout(loadScreens, 500);
        }


        function refreshScreen(screenId) {
            window.electron.refreshScreen(screenId);
            showNotification(`Pantalla ${screenId} recargada`, 'success');
        }

        async function closeScreen(screenId) {
            if (await showModal('Cerrar Contenido', `¿Cerrar pantalla ${screenId}?`, 'Cerrar', true)) {
                window.electron.closeScreen(screenId);
                setTimeout(loadScreens, 300);
            }
        }

        /**
         * INITIALIZATION & POLLING
         */
        async function loadPresets() {
            try {
                const presets = await window.electron.getPresets();
                if (!presets) return;

                const grouped = presets.reduce((acc, p) => {
                    if (!acc[p.category]) acc[p.category] = [];
                    acc[p.category].push(p);
                    return acc;
                }, {});

                let html = '<option value="">Seleccionar contenido...</option>';
                for (const [cat, items] of Object.entries(grouped)) {
                    html += `<optgroup label="${cat}">`;
                    items.forEach(i => html += `<option value="${i.url}">${i.name}</option>`);
                    html += `</optgroup>`;
                }
                presetsHtml = html;

                // Refresh any existing selects that are currently showing "Cargando..."
                document.querySelectorAll('.preset-select').forEach(sel => {
                    if (!sel.value) sel.innerHTML = html;
                });
            } catch (e) { console.error('Presets failed', e); }
        }

        // Delegate Luckia toggle logic to the list container
        screensList.addEventListener('change', async (e) => {
            if (e.target.classList.contains('preset-select')) {
                const screenId = e.target.dataset.screenId;
                const text = e.target.options[e.target.selectedIndex].text;
                const credsDiv = document.getElementById(`creds-${screenId}`);

                if (text.toLowerCase().includes('luckia')) {
                    credsDiv.classList.remove('hidden');
                    const user = await window.electron.getCredential('luckia_user');
                    const pass = await window.electron.getCredential('luckia_pass');
                    if (user) document.getElementById(`user-${screenId}`).value = user;
                    if (pass) document.getElementById(`pass-${screenId}`).value = pass;
                } else {
                    credsDiv.classList.add('hidden');
                }
            }
        });

        async function updateGpuStatus() {
            try {
                const status = await window.electron.getGpuStatus();
                document.getElementById('gpu-name').textContent = status.gpuName;
                const b = document.getElementById('gpu-badge');
                if (status.isOptimal) {
                    b.className = 'gpu-badge optimal';
                    document.getElementById('gpu-icon').textContent = 'check_circle';
                } else {
                    b.className = 'gpu-badge warning';
                    document.getElementById('gpu-icon').textContent = 'warning';
                }
            } catch (err) { }
        }

        document.getElementById('btn-minimize').addEventListener('click', () => window.electron.minimizeWindow());
        document.getElementById('btn-window-close').addEventListener('click', () => window.electron.closeWindow());
        document.getElementById('btn-restart').addEventListener('click', async () => {
            if (await showModal('Reiniciar App', '¿Reiniciar Screens?', 'Reiniciar')) window.electron.sendAction('restart');
        });
        document.getElementById('btn-quit').addEventListener('click', async () => {
            if (await showModal('Cerrar App', '¿Cerrar Screens?', 'Cerrar', true)) window.electron.sendAction('quit');
        });
        document.getElementById('btn-logs').addEventListener('click', () => window.electron.sendAction('open-logs'));
        document.getElementById('btn-update').addEventListener('click', () => {
            showNotification('Buscando actualizaciones...', 'info');
            window.electron.sendAction('update');
        });

        window.electron.getAppVersion().then(v => document.getElementById('agent-version').textContent = 'v' + v);

        async function checkSetup() {
            const settings = await window.electron.getSettings();
            if (!settings || !settings.stationName) {
                showSetupModal(true);
            } else {
                document.getElementById('station-name-display').textContent = settings.stationName;
            }
        }

        function showSetupModal(isFirstRun = false) {
            const modal = document.getElementById('setup-modal');
            const title = document.getElementById('setup-modal-title');
            const btn = document.getElementById('btn-save-setup');
            const cancelBtn = document.getElementById('btn-cancel-setup');
            const input = document.getElementById('setup-station-name');

            if (isFirstRun) {
                title.textContent = 'Configuración Inicial';
                btn.textContent = 'Completar Instalación';
                cancelBtn.classList.add('hidden');
            } else {
                title.textContent = 'Nombre del salon';
                btn.textContent = 'Guardar Cambios';
                cancelBtn.classList.remove('hidden');
                input.value = document.getElementById('station-name-display').textContent;
            }
            modal.classList.add('show');
            input.focus();
        }

        async function saveSetup() {
            const name = document.getElementById('setup-station-name').value.trim();
            if (!name) return showNotification('El nombre es obligatorio', 'warning');

            const settings = await window.electron.getSettings();
            settings.stationName = name;

            const ok = await window.electron.saveSettings(settings);
            if (ok) {
                document.getElementById('station-name-display').textContent = name;
                document.getElementById('setup-modal').classList.remove('show');
                showNotification('Configuración guardada', 'success');
            }
        }

        document.getElementById('btn-save-setup').addEventListener('click', saveSetup);
        document.getElementById('btn-cancel-setup').addEventListener('click', () => {
            document.getElementById('setup-modal').classList.remove('show');
        });
        document.getElementById('setup-station-name').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') saveSetup();
        });

        document.getElementById('station-name-display').addEventListener('click', () => showSetupModal(false));

        checkSetup();
        loadPresets().then(loadScreens);
        updateGpuStatus();
        setInterval(updateGpuStatus, 30000);
        setInterval(loadScreens, 2000);
    </script>
</body>

</html>