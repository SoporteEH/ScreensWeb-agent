<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screens Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="styles/control.css">
</head>

<body>
    <div id="boot-overlay" class="boot-overlay">
        <div class="boot-logo">
            <span class="material-icons" style="font-size: 32px; color: white;">monitor</span>
        </div>
        <div class="boot-text">Iniciando Screens</div>
        <div class="boot-subtext" id="boot-status">Sincronizando sistemas...</div>
        <div class="boot-spinner"></div>
    </div>

    <div class="title-bar">
        <div class="title-bar-left">
            <div class="title-bar-logo">
                <span class="material-icons">monitor</span>
            </div>
            <span class="title-bar-text">Screens</span>
            <span class="title-bar-version" id="agent-version"></span>
        </div>

        <span id="station-name-display" class="station-tag" title="Nombre del salon">Salon</span>

        <div class="title-bar-controls">
            <div class="title-bar-button" id="btn-minimize">
                <span class="material-icons">minimize</span>
            </div>
            <div class="title-bar-button close" id="btn-window-close">
                <span class="material-icons">close</span>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="screens-panel">
            <div class="panel-header">
                <div class="panel-title">
                    <span class="material-icons">desktop_windows</span>
                    Pantallas Conectadas
                </div>
                <div class="panel-header-actions">
                     <button class="btn btn-secondary" onclick="identifyAllScreens()" title="Identificar todas las pantallas" 
                        style="width: auto; height: 30px; padding: 0 12px; font-size: 11px; gap: 6px; min-height: 0;">
                        <span class="material-icons" style="font-size: 16px;">visibility</span>
                        IDENTIFICAR PANTALLAS
                    </button>
                <span class="screens-count" id="screens-count">0</span>
            </div>
        </div>
        <div class="screens-list" id="screens-list"></div>
        </div>

        <div class="controls-panel">
            <div class="card">
                <div id="gpu-diagnostic-container">
                    <div class="gpu-badge" id="gpu-badge">
                        <span class="material-icons gpu-icon" id="gpu-icon">memory</span>
                        <div class="gpu-info-text">
                            <span class="gpu-name" id="gpu-name" style="color:#fff; font-weight:600; display:block; font-size:11px;">
                                Cargando...
                            </span>
                        </div>
                        <span class="material-icons refresh-gpu-btn" 
                              onclick="updateGpuStatus(true)" 
                              title="Volver a escanear hardware">
                            refresh
                        </span>
                    </div>
                </div>
                <div class="agent-actions" style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn btn-secondary" id="btn-restart">
                        <span class="material-icons">restart_alt</span>
                        Reiniciar App
                    </button>
                    <button class="btn btn-secondary" id="btn-update">
                        <span class="material-icons">system_update</span>
                        Buscar Actualización
                    </button>
                    <button class="btn btn-secondary" id="btn-logs">
                        <span class="material-icons">description</span>
                        Logs del Sistema
                    </button>
                    <hr style="border:0; border-top:1px solid #444;">
                    <button class="btn btn-danger" id="btn-quit">
                        <span class="material-icons">power_settings_new</span>
                        Cerrar Aplicación
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal">
            <div class="modal-title" id="modal-title"></div>
            <div class="modal-message" id="modal-message"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" id="modal-cancel">Cancelar</button>
                <button class="modal-btn modal-btn-confirm" id="modal-confirm">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- Setup Modal -->
    <div id="setup-modal" class="modal-overlay" style="z-index: 2000;">
        <div class="modal" style="max-width: 400px; text-align: center;">
            <div class="modal-header"
                style="margin-bottom:15px; border-bottom:1px solid var(--color-border); padding-bottom:10px;">
                <h3 id="setup-modal-title" style="color:var(--color-primary);">Configuración Inicial</h3>
            </div>
            <div class="modal-body">
                <input type="text" id="setup-station-name" class="setup-input" placeholder="Nombre del Local"
                    maxlength="30">
            </div>
            <div class="modal-footer" style="margin-top:20px; display: flex; gap: 10px;">
                <button id="btn-cancel-setup" class="modal-btn-cancel hidden"
                    style="flex: 1; height:44px; border-radius:8px; cursor:pointer;">Cancelar</button>
                <button id="btn-save-setup" class="modal-btn-confirm"
                    style="flex: 2; height:44px; border-radius:8px; border:none; cursor:pointer; font-weight:600;">Completar
                    Instalación</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * GLOBAL STATE & REFS
         */
        let screens = [];
        let presetsHtml = '';
        const screensList = document.getElementById('screens-list');
        const screensCount = document.getElementById('screens-count');
        const modalOverlay = document.getElementById('modal-overlay');
        let modalCallback = null;

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => notification.classList.remove('show'), 4000);
        }

        function showModal(title, message, confirmText = 'Aceptar', isDanger = false) {
            return new Promise((resolve) => {
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-message').textContent = message;
                const confirmBtn = document.getElementById('modal-confirm');
                confirmBtn.textContent = confirmText;
                confirmBtn.classList.toggle('danger', isDanger);
                modalOverlay.classList.add('show');
                modalCallback = resolve;
            });
        }

        function hideModal() { modalOverlay.classList.remove('show'); }

        document.getElementById('modal-confirm').addEventListener('click', () => { hideModal(); if (modalCallback) modalCallback(true); });
        document.getElementById('modal-cancel').addEventListener('click', () => { hideModal(); if (modalCallback) modalCallback(false); });

        /**
         * RENDER LOGIC
         */
        async function loadScreens() {
            try {
                screens = await window.electron.getScreens();
                renderScreensList();
            } catch (error) { console.error('Error loading screens:', error); }
        }

        function renderScreensList() {
            if (screensCount) screensCount.textContent = screens.length;

            const container = document.getElementById('screens-list');
            const currentIds = screens.map(s => s.id).join(',');
            const lastIds = container.dataset.screenIds || '';

            // STRUCTURAL REFRESH: Only redraw everything if the monitors changed
            if (currentIds !== lastIds) {
                container.dataset.screenIds = currentIds;
                container.innerHTML = screens.map(renderScreenCard).join('');
                return;
            }

            // SURGICAL REFRESH: Update only classes and status text
            screens.forEach(screen => {
                const card = container.querySelector(`.screen-card[data-id="${screen.id}"]`);
                if (!card) return;

                // PROTECTION: Skip surgical updates for this card if the user is interacting with it
                const activeEl = document.activeElement;
                if (activeEl && card.contains(activeEl) && (activeEl.tagName === 'SELECT' || activeEl.tagName === 'INPUT')) {
                    return;
                }

                // Update active state class
                card.classList.toggle('active', screen.hasContent);
                card.classList.toggle('empty', !screen.hasContent);

                // Update status display
                const statusDiv = card.querySelector('.screen-current-status');
                const statusHtml = renderStatusHtml(screen);
                if (statusDiv.innerHTML !== statusHtml) {
                    statusDiv.innerHTML = statusHtml;
                }

                // Update action buttons (Injecting the full HTML to include the new Identify button)
                const actionsDiv = card.querySelector('.screen-actions-container');
                // Reconstruimos el HTML de los botones para asegurar que el estado (close/refresh) es correcto
                const actionsHtml = `
                    <button class="btn-mini secondary" onclick="window.electron.identifyScreen('${screen.id}')" title="Identificar esta pantalla">
                        <span class="material-icons" style="font-size:14px;">visibility</span>
                    </button>
                    <button class="btn-mini primary" onclick="sendUrl('${screen.id}', this)">
                        <span class="material-icons" style="font-size:14px;">send</span> Enviar
                    </button>
                    ${screen.hasContent ? `
                        <button class="btn-mini secondary" onclick="refreshScreen('${screen.id}')" title="Recargar">
                            <span class="material-icons" style="font-size:14px;">refresh</span>
                        </button>
                        <button class="btn-mini danger" onclick="closeScreen('${screen.id}')" title="Cerrar">
                            <span class="material-icons" style="font-size:14px;">close</span>
                        </button>
                    ` : ''}
                `;
        
                if (actionsDiv.innerHTML.trim() !== actionsHtml.trim()) {
                    actionsDiv.innerHTML = actionsHtml;
                }

                // RE-HYDRATION: If presets were previously "Cargando..."
                const select = card.querySelector('.preset-select');
                if (select && presetsHtml && select.options.length <= 1) {
                    select.innerHTML = presetsHtml;
                }
            });
        }
        function renderScreenCard(screen) {
    return `
        <div class="screen-card ${screen.hasContent ? 'active' : 'empty'}" data-id="${screen.id}">
            <div class="screen-header">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span class="screen-badge">Pantalla ${screen.id}</span>
                    <div title="Intervalo de recarga" style="display: flex; align-items: center; gap: 6px; background: rgba(255,102,0,0.1); padding: 4px 10px; border-radius: 4px; border: 1px solid rgba(255,102,0,0.3);">
                        <span class="material-icons" style="font-size: 14px; color: #ff6600;">schedule</span>
                        <input type="number" class="refresh-input" 
                            value="${screen.refreshInterval || 0}" 
                            min="0" max="1440" 
                            onfocus="if(this.value=='0')this.value=''" 
                            onblur="if(this.value=='')this.value='0'"
                            style="width: 35px; background: transparent; border: none; color: #fff; font-size: 12px; font-weight: 700; outline: none; text-align: center;">
                        <span style="font-size: 10px; color: #888; font-weight: 700;">MIN</span>
                    </div>
                </div>
                <span class="screen-resolution-btn" onclick="window.electron.openDisplaySettings()" title="Configuración Windows">
                    ${screen.width}x${screen.height} 
                    <span class="material-icons" style="font-size: 10px;">open_in_new</span>
                </span>
            </div>

            <div class="screen-current-status" style="margin:10px 0; font-size:13px;">
                ${renderStatusHtml(screen)}
            </div>

            <div style="display:flex; flex-direction:column; gap:8px;">
                <select class="form-control preset-select" data-screen-id="${screen.id}">
                    ${presetsHtml || '<option value="">Cargando...</option>'}
                </select>

                <div class="credentials-inline hidden" id="creds-${screen.id}">
                    <input type="text" class="form-control small-input user-input" placeholder="Usuario" id="user-${screen.id}">
                    <input type="password" class="form-control small-input pass-input" placeholder="Contraseña" id="pass-${screen.id}">
                </div>

                <div class="screen-actions-container">
                    <button class="btn-secondary" onclick="window.electron.identifyScreen('${screen.id}')" title="Identificar">
                        <span class="material-icons">visibility</span>
                    </button>
                    <button class="btn-primary" onclick="sendUrl('${screen.id}', this)">
                        <span class="material-icons">send</span> ENVIAR
                    </button>
                    
                    ${screen.hasContent ? `
                        <!-- Recargar -->
                        <button class="btn btn-secondary" onclick="refreshScreen('${screen.id}')" title="Recargar">
                            <span class="material-icons">refresh</span>
                        </button>
                        
                        <!-- Cerrar (Usamos btn-danger para rojo) -->
                        <button class="btn btn-danger" onclick="closeScreen('${screen.id}')" title="Cerrar">
                            <span class="material-icons">close</span>
                        </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
}
        function renderStatusHtml(screen) {
            return screen.hasContent ?
                `<div style="color:var(--color-success); display:flex; align-items:center; gap:6px; font-weight:600;">
                    <span class="material-icons" style="font-size:18px;">play_circle</span>
                    ${screen.contentName || 'Contenido Activo'}
                 </div>` :
                `<div style="color:#666; font-style:italic; display:flex; align-items:center; gap:6px;">
                    <span class="material-icons" style="font-size:18px; opacity:0.5;">pause_circle</span>
                    Sin contenido
                 </div>`;
        }

        function renderActionsHtml(screen) {
            return `
                <button class="btn btn-secondary" onclick="window.electron.identifyScreen('${screen.id}')" title="Identificar" style="width: auto !important; height: 30px !important; padding: 0 12px !important; font-size: 11px !important; display: inline-flex !important; gap: 6px !important;">
                    <span class="material-icons" style="font-size:16px !important;">visibility</span>
                </button>

                <button class="btn btn-primary" onclick="sendUrl('${screen.id}')" style="width: auto !important; height: 30px !important; padding: 0 12px !important; font-size: 11px !important; display: inline-flex !important; gap: 6px !important;">
                    <span class="material-icons" style="font-size:16px !important;">send</span> ENVIAR
                </button>

                ${screen.hasContent ? `
                    <button class="btn btn-secondary" onclick="refreshScreen('${screen.id}')" title="Recargar" style="width: auto !important; height: 30px !important; padding: 0 12px !important; font-size: 11px !important; display: inline-flex !important; gap: 6px !important;">
                        <span class="material-icons" style="font-size:16px !important;">refresh</span>
                    </button>
                
                    <button class="btn btn-danger" onclick="closeScreen('${screen.id}')" title="Cerrar" style="width: auto !important; height: 30px !important; padding: 0 12px !important; font-size: 11px !important; display: inline-flex !important; gap: 6px !important;">
                        <span class="material-icons" style="font-size:16px !important;">close</span>
                    </button>
                ` : ''}
            `;
        }

        function identifyAllScreens() {
            if (screens.length === 0) return;
            screens.forEach(s => window.electron.identifyScreen(s.id));
            showNotification('Identificando todas las pantallas...', 'info');
        }

        /**
         * ACTIONS
         */
        async function sendUrl(screenId) {
            const btn = event.currentTarget;
            if (btn.disabled) return;

            btn.disabled = true;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<span class="material-icons" style="font-size:14px; animation: spin 1s linear infinite;">autorenew</span>';

            const card = document.querySelector(`.screen-card[data-id="${screenId}"]`);
            const select = card.querySelector('.preset-select');
            const refreshInput = card.querySelector('.refresh-input');
            const url = select.value;
            const interval = parseInt(refreshInput.value) || 0;

            if (!url) return showNotification('Selecciona contenido', 'warning');

            let credentials = null;
            const contentName = select.options[select.selectedIndex].text;

            // Luckia-specific credentials handling
            if (contentName.toLowerCase().includes('luckia')) {
                const user = document.getElementById(`user-${screenId}`).value.trim();
                const pass = document.getElementById(`pass-${screenId}`).value.trim();
                if (user && pass) {
                    credentials = { username: user, password: pass };
                    await window.electron.saveCredential('luckia_user', user);
                    await window.electron.saveCredential('luckia_pass', pass);
                } else {
                    return showNotification('Luckia requiere credenciales', 'warning');
                }
            }

            window.electron.sendUrlToScreen(screenId, url, {
                contentName,
                refreshInterval: interval,
                credentials
            });
            showNotification(`Enviando a Pantalla ${screenId}...`, 'success');

            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
                loadScreens();
            }, 800);
        }


        function refreshScreen(screenId) {
            window.electron.refreshScreen(screenId);
            showNotification(`Pantalla ${screenId} recargada`, 'success');
        }

        async function closeScreen(screenId) {
            if (await showModal('Cerrar Contenido', `¿Cerrar pantalla ${screenId}?`, 'Cerrar', true)) {
                window.electron.closeScreen(screenId);
                setTimeout(loadScreens, 300);
            }
        }

        /**
         * INITIALIZATION & POLLING
         */
        async function loadPresets() {
            try {
                const presets = await window.electron.getPresets();
                if (!presets) return;

                const grouped = presets.reduce((acc, p) => {
                    if (!acc[p.category]) acc[p.category] = [];
                    acc[p.category].push(p);
                    return acc;
                }, {});

                let html = '<option value="">Seleccionar contenido...</option>';
                for (const [cat, items] of Object.entries(grouped)) {
                    html += `<optgroup label="${cat}">`;
                    items.forEach(i => html += `<option value="${i.url}">${i.name}</option>`);
                    html += `</optgroup>`;
                }
                presetsHtml = html;

                // Refresh any existing selects that are currently showing "Cargando..."
                document.querySelectorAll('.preset-select').forEach(sel => {
                    if (!sel.value) sel.innerHTML = html;
                });
            } catch (e) { console.error('Presets failed', e); }
        }

        // Delegate Luckia toggle logic to the list container
        screensList.addEventListener('change', async (e) => {
            if (e.target.classList.contains('preset-select')) {
                const screenId = e.target.dataset.screenId;
                const text = e.target.options[e.target.selectedIndex].text;
                const credsDiv = document.getElementById(`creds-${screenId}`);

                if (text.toLowerCase().includes('luckia')) {
                    credsDiv.classList.remove('hidden');
                    const user = await window.electron.getCredential('luckia_user');
                    const pass = await window.electron.getCredential('luckia_pass');
                    if (user) document.getElementById(`user-${screenId}`).value = user;
                    if (pass) document.getElementById(`pass-${screenId}`).value = pass;
                } else {
                    credsDiv.classList.add('hidden');
                }
            }
        });

        async function updateGpuStatus(force = false) {
            const btn = document.querySelector('.refresh-gpu-btn');
            const nameLabel = document.getElementById('gpu-name');
    
            // Feedback visual de carga
            if (force && btn) btn.classList.add('spin-animate');
            if (force) nameLabel.style.opacity = '0.5';

            try {
                // Pasamos { force: true } si el usuario hizo clic
                const status = await window.electron.getGpuStatus({ force: force });
                
                document.getElementById('gpu-name').textContent = status.gpuName;
                const b = document.getElementById('gpu-badge');
        
                if (status.isOptimal) {
                    b.className = 'gpu-badge optimal';
                    document.getElementById('gpu-icon').textContent = 'check_circle';
                } else {
                    b.className = 'gpu-badge warning';
                    document.getElementById('gpu-icon').textContent = 'warning';
                }
            } catch (err) {
                console.error("GPU Check failed", err);
            } finally {
                // Quitar animación
                if (btn) btn.classList.remove('spin-animate');
                nameLabel.style.opacity = '1';
            }
        }

        document.getElementById('btn-minimize').addEventListener('click', () => window.electron.minimizeWindow());
        document.getElementById('btn-window-close').addEventListener('click', () => window.electron.closeWindow());
        document.getElementById('btn-restart').addEventListener('click', async () => {
            if (await showModal('Reiniciar App', '¿Reiniciar Screens?', 'Reiniciar')) window.electron.sendAction('restart');
        });
        document.getElementById('btn-quit').addEventListener('click', async () => {
            if (await showModal('Cerrar App', '¿Cerrar Screens?', 'Cerrar', true)) window.electron.sendAction('quit');
        });
        document.getElementById('btn-logs').addEventListener('click', () => window.electron.sendAction('open-logs'));
        document.getElementById('btn-update').addEventListener('click', () => {
            showNotification('Buscando actualizaciones...', 'info');
            window.electron.sendAction('update');
        });

        window.electron.getAppVersion().then(v => document.getElementById('agent-version').textContent = 'v' + v);

        async function checkSetup() {
            const settings = await window.electron.getSettings();
            if (!settings || !settings.stationName) {
                showSetupModal(true);
            } else {
                document.getElementById('station-name-display').textContent = settings.stationName;
            }
        }

        function showSetupModal(isFirstRun = false) {
            const modal = document.getElementById('setup-modal');
            const title = document.getElementById('setup-modal-title');
            const btn = document.getElementById('btn-save-setup');
            const cancelBtn = document.getElementById('btn-cancel-setup');
            const input = document.getElementById('setup-station-name');

            if (isFirstRun) {
                title.textContent = 'Configuración Inicial';
                btn.textContent = 'Completar Instalación';
                cancelBtn.classList.add('hidden');
            } else {
                title.textContent = 'Nombre del salon';
                btn.textContent = 'Guardar Cambios';
                cancelBtn.classList.remove('hidden');
                input.value = document.getElementById('station-name-display').textContent;
            }
            modal.classList.add('show');
            input.focus();
        }

        async function saveSetup() {
            const name = document.getElementById('setup-station-name').value.trim();
            if (!name) return showNotification('El nombre es obligatorio', 'warning');

            const settings = await window.electron.getSettings();
            settings.stationName = name;

            const ok = await window.electron.saveSettings(settings);
            if (ok) {
                document.getElementById('station-name-display').textContent = name;
                document.getElementById('setup-modal').classList.remove('show');
                showNotification('Configuración guardada', 'success');
            }
        }

        document.getElementById('btn-save-setup').addEventListener('click', saveSetup);
        document.getElementById('btn-cancel-setup').addEventListener('click', () => {
            document.getElementById('setup-modal').classList.remove('show');
        });
        document.getElementById('setup-station-name').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') saveSetup();
        });

        document.getElementById('station-name-display').addEventListener('click', () => showSetupModal(false));

        window.electron.onScreensChanged(() => {
            console.log('Hardware change detected, forcing structural refresh');
            const container = document.getElementById('screens-list');
            if (container) container.dataset.screenIds = ''; // Clear to force redraw
            loadScreens();
        });

        async function initApp() {
            const bootOverlay = document.getElementById('boot-overlay');
            const bootStatus = document.getElementById('boot-status');
            updateGpuStatus(false);

            try {
                // Phase 1: Basic App Info & Settings
                bootStatus.textContent = 'Configurando entorno...';
                await checkSetup();
                const version = await window.electron.getAppVersion();
                document.getElementById('agent-version').textContent = 'v' + version;

                // Phase 2: Presets (Crucial for UI population)
                bootStatus.textContent = 'Cargando contenidos...';
                await loadPresets();

                // Phase 3: Hardware & GPU
                bootStatus.textContent = 'Detectando hardware...';
                await Promise.all([
                    loadScreens(),
                    updateGpuStatus()
                ]);

                // Phase 4: Finish line
                bootStatus.textContent = 'Listo';
                setTimeout(() => {
                    bootOverlay.classList.add('hidden');
                }, 500);

                // Start background polling only after initial load success
                setInterval(loadScreens, 2000);
            } catch (err) {
                console.error('Boot error:', err);
                bootStatus.textContent = 'Error al iniciar. Reintentando...';
                setTimeout(initApp, 2000);
            }
        }

        initApp();
    </script>
</body>

</html>